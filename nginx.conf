worker_processes auto;

events {
    worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=10s ipv6=off;

    map $arg_chain $backend {
        default         "";
        "ethereum"      "ypm-ethereum";
        "arbitrum"      "ypm-arbitrum";
        "optimism"      "ypm-optimism";
        "base"          "ypm-base";
    }

    server {
        listen 8000;
        default_type application/json;

        proxy_intercept_errors on;
        error_page 502 503 504 =502 @backend_down;

        location @backend_down {
            default_type application/json;
            return 502 '{"error": "Chain backend is unavailable"}';
        }

        location = / {
            set $ui_backend ypm-ethereum:8001;
            proxy_pass http://$ui_backend;
            proxy_set_header Host $host;
        }

        # Aggregate health: returns ok if any backend is reachable.
        # Use /health/{chain} for per-chain checks.
        location = /health {
            set $health_backend ypm-ethereum:8001;
            proxy_pass http://$health_backend;
            proxy_set_header Host $host;
        }

        location ~ ^/health/(?<chain_name>ethereum|arbitrum|optimism|base)$ {
            set $health_chain_backend ypm-$chain_name:8001;
            proxy_pass http://$health_chain_backend/health;
            proxy_set_header Host $host;
        }

        location = /price {
            if ($arg_chain = "") {
                return 400 '{"error": "Missing required parameter: chain"}';
            }
            if ($backend = "") {
                return 400 '{"error": "Unknown chain. Supported: ethereum, arbitrum, optimism, base"}';
            }

            proxy_pass http://$backend:8001;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;
        }
    }
}
