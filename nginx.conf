worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream ypm-ethereum { server ypm-ethereum:8001; }
    upstream ypm-arbitrum { server ypm-arbitrum:8001; }
    upstream ypm-optimism { server ypm-optimism:8001; }
    upstream ypm-base     { server ypm-base:8001; }
    upstream ypm-polygon  { server ypm-polygon:8001; }

    map $arg_chain $backend {
        default         "";
        "ethereum"      "ypm-ethereum";
        "arbitrum"      "ypm-arbitrum";
        "optimism"      "ypm-optimism";
        "base"          "ypm-base";
        "polygon"       "ypm-polygon";
    }

    server {
        listen 8000;

        # HTML UI -- proxy to any backend (they all serve the same page)
        location = / {
            proxy_pass http://ypm-ethereum:8001;
            proxy_set_header Host $host;
        }

        # Health check -- fan out to all backends
        location = /health {
            proxy_pass http://ypm-ethereum:8001;
            proxy_set_header Host $host;
        }

        # Price endpoint -- route by chain param
        location = /price {
            if ($arg_chain = "") {
                return 400 '{"error": "Missing required parameter: chain"}';
            }
            if ($backend = "") {
                return 400 '{"error": "Unknown chain. Supported: ethereum, arbitrum, optimism, base, polygon"}';
            }

            proxy_pass http://$backend:8001;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;

            add_header Content-Type application/json always;
        }
    }
}
