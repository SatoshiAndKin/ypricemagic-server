worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream ypm-ethereum { server ypm-ethereum:8001; }
    upstream ypm-arbitrum { server ypm-arbitrum:8001; }
    upstream ypm-optimism { server ypm-optimism:8001; }
    upstream ypm-base     { server ypm-base:8001; }

    map $arg_chain $backend {
        default         "";
        "ethereum"      "ypm-ethereum";
        "arbitrum"      "ypm-arbitrum";
        "optimism"      "ypm-optimism";
        "base"          "ypm-base";
    }

    server {
        listen 8000;
        default_type application/json;

        location = / {
            proxy_pass http://ypm-ethereum:8001;
            proxy_set_header Host $host;
        }

        # Aggregate health: proxies to any single backend.
        # Use /health/{chain} for per-chain checks.
        location = /health {
            proxy_pass http://ypm-ethereum:8001;
            proxy_set_header Host $host;
        }

        location ~ ^/health/(?<chain_name>ethereum|arbitrum|optimism|base)$ {
            proxy_pass http://ypm-$chain_name:8001/health;
            proxy_set_header Host $host;
        }

        location = /price {
            if ($arg_chain = "") {
                return 400 '{"error": "Missing required parameter: chain"}';
            }
            if ($backend = "") {
                return 400 '{"error": "Unknown chain. Supported: ethereum, arbitrum, optimism, base"}';
            }

            proxy_pass http://$backend:8001;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;
        }
    }
}
