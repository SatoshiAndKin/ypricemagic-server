worker_processes auto;

events {
    worker_connections 1024;
}

http {
    server {
        listen 8000;
        default_type application/json;

        proxy_intercept_errors on;
        error_page 502 503 504 =502 @backend_down;

        location @backend_down {
            default_type application/json;
            return 502 '{"error": "Chain backend is unavailable"}';
        }

        location = / {
            proxy_pass http://ypm-ethereum:8001;
            proxy_set_header Host $host;
        }

        # Aggregate health: proxies to any single backend.
        # Use /<chain>/health for per-chain checks.
        location = /health {
            proxy_pass http://ypm-ethereum:8001;
            proxy_set_header Host $host;
        }

        location /ethereum/ {
            proxy_pass http://ypm-ethereum:8001/;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;
        }

        location /arbitrum/ {
            proxy_pass http://ypm-arbitrum:8001/;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;
        }

        location /optimism/ {
            proxy_pass http://ypm-optimism:8001/;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;
        }

        location /base/ {
            proxy_pass http://ypm-base:8001/;
            proxy_set_header Host $host;
            proxy_read_timeout 120s;
        }
    }
}
